# üõ°Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS-over-TLS –Ω–∞ Ubuntu Server (AdGuard + Cloudflare + Google)

> \[!IMPORTANT]
> –í –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ DNS –Ω–∞ —Å–∞–º–æ–º —Å–µ—Ä–≤–µ—Ä–µ DNS <br> 
> –ù–∞ –∫–æ—Ç–æ—Ä–æ–º —É –Ω–∞—Å —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç AdGuard

–ù–∞–¥—ë–∂–Ω–∞—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è DNS —á–µ—Ä–µ–∑ `systemd-resolved` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö DNS-–∑–∞–ø—Ä–æ—Å–æ–≤ (DoT)** –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º DHCP/Cloud-init –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞.

---

## üìë –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–ø–∏—Å–∞–Ω–∏–µ](#–æ–ø–∏—Å–∞–Ω–∏–µ)
- [1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è](#–ø—Ä–æ–≤–µ—Ä–∫–∞-—Ç–µ–∫—É—â–µ–≥–æ-—Å–æ—Å—Ç–æ—è–Ω–∏—è)
- [2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ IP](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-—Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ-ip)
- [3Ô∏è‚É£ –û—Ç–∫–ª—é—á–µ–Ω–∏–µ Cloud-init –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞](#–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ-cloud-init-–≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞)
- [4Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd-resolved](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-systemd-resolved)
- [5Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ DNS](#–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫-–∏-–ø—Ä–æ–≤–µ—Ä–∫–∞-dns)
- [6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS-over-TLS](#–ø—Ä–æ–≤–µ—Ä–∫–∞-dns-over-tls)
- [‚úÖ –ò—Ç–æ–≥–∏](#–∏—Ç–æ–≥–∏)

---

## üìò –û–ø–∏—Å–∞–Ω–∏–µ <a id="–æ–ø–∏—Å–∞–Ω–∏–µ"></a>

–¶–µ–ª—å ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–∞–¥—ë–∂–Ω—É—é, –ø–æ–ª–Ω–æ—Å—Ç—å—é **–ª–æ–∫–∞–ª—å–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ–º—É—é DNS-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é** –±–µ–∑ DHCP-–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π.  
–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
- üîπ **AdGuard DNS** –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω—ã–µ (—á–µ—Ä–µ–∑ DoT)  
- üîπ **Cloudflare –∏ Google DNS** –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ  
- üîí **DNSSEC** –∏ **DNS-over-TLS** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏–º—ë–Ω  

---

## 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è <a id="–ø—Ä–æ–≤–µ—Ä–∫–∞-—Ç–µ–∫—É—â–µ–≥–æ-—Å–æ—Å—Ç–æ—è–Ω–∏—è"></a>

–ü–æ—Å–º–æ—Ç—Ä–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ –∞–∫—Ç–∏–≤–Ω—ã–µ DNS:

```bash
ip -c -br a
ip route
resolvectl status
````

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:

```
lo               UNKNOWN        127.0.0.1/8
eth0             UP             192.168.10.52/24
default via 192.168.10.1 dev eth0 proto dhcp src 192.168.10.52
DNS Servers: 1.1.1.1
Fallback DNS Servers: 8.8.8.8
```

---

## 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ IP <a id="–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-—Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ-ip"></a>

–ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–∞—Ç–∞–ª–æ–≥ —Å –∫–æ–Ω—Ñ–∏–≥–∞–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤:

```bash
cd /etc/network/interfaces.d
```

–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º (–∏–ª–∏ —Å–æ–∑–¥–∞—ë–º) —Ñ–∞–π–ª `eth0`:

```bash
nano /etc/network/interfaces.d/eth0
```

–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```ini
auto eth0
iface eth0 inet static
    address 192.168.10.52
    netmask 255.255.255.0
    gateway 192.168.10.1
```

---

## 3Ô∏è‚É£ –û—Ç–∫–ª—é—á–µ–Ω–∏–µ Cloud-init –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ <a id="–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ-cloud-init-–≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞"></a>

Cloud-init —á–∞—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –ß—Ç–æ–±—ã —ç—Ç–æ–≥–æ –∏–∑–±–µ–∂–∞—Ç—å:

```bash
nano /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
```

–í—Å—Ç–∞–≤–ª—è–µ–º:

```yaml
network: {config: disabled}
```

–£–¥–∞–ª—è–µ–º —Å–µ—Ç–µ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã Cloud-init:

```bash
rm -rf /etc/netplan
rm -rf /etc/cloud/cloud.cfg.d/subiquity-disable-cloudinit-networking.cfg
rm -rf /var/lib/cloud/sem/* /var/lib/cloud/instance /var/lib/cloud/instances/*
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–±—ã:

```bash
systemctl restart cloud-init
systemctl restart networking
systemctl restart systemd-resolved
```

> –ï—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ `networking.service`, –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä.

---

## 4Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd-resolved <a id="–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-systemd-resolved"></a>

–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥:

```bash
nano /etc/systemd/resolved.conf
```

> ‚ö†Ô∏è –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤ DNS —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π IP (–≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è).

–ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä:

```ini
[Resolve]
# –û—Å–Ω–æ–≤–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ DNS —á–µ—Ä–µ–∑ DoT (AdGuard)
DNS=94.140.14.14#dns.adguard.com
DNS=94.140.15.15#dns.adguard.com

# –†–µ–∑–µ—Ä–≤–Ω—ã–µ (Cloudflare + Google DoT)
FallbackDNS=1.1.1.1#cloudflare-dns.com
FallbackDNS=8.8.8.8#dns.google

# –í–∫–ª—é—á–∏—Ç—å DNS over TLS
DNSOverTLS=yes

# DNSSEC –ø—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
DNSSEC=allow-downgrade

# –†–∞–∑—Ä–µ—à–∏—Ç—å –∫—ç—à
Cache=yes

# –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MulticastDNS/LLMNR
MulticastDNS=no
LLMNR=no
```

–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º:

```bash
systemctl restart systemd-resolved
resolvectl flush-caches
```

---

## 5Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ DNS <a id="–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫-–∏-–ø—Ä–æ–≤–µ—Ä–∫–∞-dns"></a>

–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Ä–≤–µ—Ä:

```bash
reboot
```

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

```bash
resolvectl status
```

–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

```
Global
         DNS Servers: 94.140.14.14#dns.adguard.com 94.140.15.15#dns.adguard.com
Fallback DNS Servers: 1.1.1.1#cloudflare-dns.com 8.8.8.8#dns.google
DNSSEC=allow-downgrade/supported
DNSOverTLS=yes
```

---

## 6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS-over-TLS <a id="–ø—Ä–æ–≤–µ—Ä–∫–∞-dns-over-tls"></a>

–ü—Ä–æ–≤–µ—Ä–∏–º –∑–∞–ø—Ä–æ—Å:

```bash
resolvectl query google.com
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```
google.com: 142.250.74.238 -- link: eth0

-- Information acquired via protocol DNS in 1.2150s.
-- Data was acquired via local or encrypted transport: yes
```

–ï—Å–ª–∏ –≤ —Å—Ç—Ä–æ–∫–µ —É–∫–∞–∑–∞–Ω–æ `encrypted transport: yes` ‚Äî
üéâ –∑–Ω–∞—á–∏—Ç **DNS-over-TLS —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**!

---

## ‚úÖ –ò—Ç–æ–≥–∏ <a id="–∏—Ç–æ–≥–∏"></a>

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –≤—ã –ø–æ–ª—É—á–∏–ª–∏:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç  | –°—Ç–∞—Ç—É—Å                                 |
| ---------- | -------------------------------------- |
| Cloud-init | üö´ –û—Ç–∫–ª—é—á—ë–Ω                            |
| DHCP       | üö´ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è                     |
| –°–µ—Ç—å       | ‚öôÔ∏è –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è                         |
| DNS        | üîí AdGuard + Cloudflare + Google (DoT) |
| DNSSEC     | ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω                              |
| –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ DNS-over-TLS –≤–∫–ª—é—á–µ–Ω                 |

