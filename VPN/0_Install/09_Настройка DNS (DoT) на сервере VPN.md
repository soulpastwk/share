## üñ• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ IP –∏ DNS (DoT) –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å Netplan 

> \[!IMPORTANT]
> ## ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï !!!
> –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ –Ω–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö - hostkey.ru –∏ hostvds.com <br>
> –ù–æ —Ç–∞–∫ –∂–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–∞ –≤—Å–µ—Ö Ubuntu –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫ <br>
> –ò –≤–µ–∑–¥–µ –≥–¥–µ —Å–µ—Ç—å—é —É–ø—Ä–∞–≤–ª—è–µ—Ç **Netplan** <br>
> –õ–∏–±–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ç—å—é –Ω–∞ **Netplan** <br>
> –ø—É—Ç—ë–º –∫–æ–º–º–∏—Ç–∞ –æ—Ç—Å–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤ –≤ **/etc/network/interfaces.d** <br>
> –°—É—Ç—å —Ç–∞–∫–æ–≤–∞ - –°–¢–ê–¢–ò–ö–ê - –Ω–∞—à–µ –í–°–Å <br>

> \[!TIP]
> –î–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –Ω–∞ —Å–≤–æ—ë–º —Å–µ—Ä–≤–µ—Ä–µ VPN. <br>
> –ï—Å–ª–∏ —É –≤–∞—Å –∫–∞—Å–∫–∞–¥–Ω—ã–π VPN - —Ç–æ –Ω–∞ –æ–±–æ–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö. <br>
> DNS –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—è—Ö **3X-UI** –Ω–µ —Ç—Ä–æ–≥–∞–µ–º - –æ—Å—Ç–∞–≤–ª—è–µ–º –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã–º. <br>
> –¢.–∫. –º—ã –ø–æ–¥–Ω—è–ª–∏ –≤—Å—ë –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–∞–º–æ–π –û–°.
---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ Ubuntu:

```bash
root@server-vpn-1:/etc/netplan# ls -lah
total 20K
drwxr-xr-x  2 root root 4.0K Sep 10 14:02 .
drwxr-xr-x 89 root root 4.0K Aug 29 12:41 ..
-rw-------  1 root root  360 Sep 10 13:58 01-netcfg.yaml
-rw-r--r--  1 root root  196 Sep 10 13:52 01-netcfg.yaml_backup
-rw-------  1 root root  389 Jun  6  2024 50-cloud-init.yaml.bak
````

–í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/etc/netplan`.

> \[!TIP]
> –ï—Å–ª–∏ –≤ —ç—Ç–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—É—Å—Ç–æ, –∑–Ω–∞—á–∏—Ç —É –≤–∞—Å –ø—Ä–æ–ø–∏—Å–∞–Ω–æ –≤ —Ñ–∞–π–ª–µ `/etc/network/interfaces` <br>
> –ò –æ–±—ã—á–Ω–æ —Ç–∞–º –ø—Ä–æ–ø–∏—Å–∞–Ω—ã –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã <br>
> –ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏–º IP v6 –∏ DNS, —Ç.–∫. –ø—Ä–æ–ø–∏—à–µ–º –≤—Å—ë –≤ —Ä–µ–∑–æ–ª–≤–µ –ø–æ—Ç–æ–º.

---

## üíæ –ö–æ–º–º–∏—Ç–∏–º –∏ –±—ç–∫–∞–ø–∏–º

* –ö–æ–º–º–∏—Ç–∏–º —Ñ–∞–π–ª `50-cloud-init.yaml` –ø—É—Ç—ë–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–Ω–∏—è –≤ `50-cloud-init.yaml.bak`
* –î–µ–ª–∞–µ–º –±—ç–∫–∞–ø `01-netcfg.yaml`
* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º `01-netcfg.yaml` –Ω–∞ —Å—Ç–∞—Ç–∏–∫—É - –Ω–∏–∂–µ –ø—Ä–∏–º–µ—Ä –≥–æ—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ <br>
  –º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∞—à ip —Å–µ—Ä–≤–µ—Ä–∞ <br>
  –¢–∞–∫ –∂–µ –∏–º—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å–≤–æ—ë –ø–∏—à–µ–º –≤ –ø–æ–ª–µ `ethernets:` —Ç—É—Ç —ç—Ç–æ ens1

```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens1:
      dhcp4: no
      dhcp6: no
      addresses:
        - 1.148.104.218/24 # ip –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
      routes:
        - to: default
          via: 1.148.104.1 

```

---

## ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### Warning 1: Permissions

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –æ—à–∏–±–∫–∏ –≤–∏–¥–∞:

```
‚ö†Ô∏è Warning 1: Permissions for /etc/netplan/01-netcfg.yaml are too open
```

–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É —Å–ª–∏—à–∫–æ–º "—à–∏—Ä–æ–∫–∏–µ".
Netplan —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã –¥–æ—Å—Ç—É–ø –±—ã–ª —Ç–æ–ª—å–∫–æ —É root.

üëâ –ò—Å–ø—Ä–∞–≤–ª—è–µ–º:

```bash
sudo chmod 600 /etc/netplan/01-netcfg.yaml
```

### Warning 2: gateway4 deprecated

```
‚ö†Ô∏è Warning 2: gateway4 has been deprecated
```

–í –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö netplan `gateway4` –∏ `gateway6` –∑–∞–º–µ–Ω–∏–ª–∏ –Ω–∞ `routes:`. <br>
–¢–∞–∫ —á—Ç–æ –µ—Å–ª–∏ —É –≤–∞—Å –ø—Ä–æ–ø–∏—Å–∞–Ω—ã `gateway4` –∏–ª–∏ `gateway6`, –º–µ–Ω—è–π—Ç–µ –Ω–∞ `routes` –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ –∫–æ–Ω—Ñ–∏–≥–∞ –≤—ã—à–µ.

---

## ‚öôÔ∏è Cloud-init

–°–µ—Ä–≤–µ—Ä–∞ –ø–æ–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º cloud-init (—Ç–∏–ø–∏—á–Ω–æ –¥–ª—è VPS) –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç —Å–≤–æ–π —Å–µ—Ç–µ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥ (`50-cloud-init.yaml`). <br>
–î–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–ø–∏—Å–∞—Ç—å —Ä—É—á–Ω–æ–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π IP –≤ `01-netcfg.yaml`, –ø–æ—Å–ª–µ —Ä–µ–±—É—Ç–∞ cloud-init –º–æ–∂–µ—Ç –≤—Å—ë –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å.

–ü–æ—ç—Ç–æ–º—É —Å–æ–∑–¥–∞—ë–º:

```bash
sudo nano /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
```

–° —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ—á–∫—É:

```yaml
network: {config: disabled}
```

> \[!TIP]
> –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ **ifupdown** –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç

```bash
apt install ifupdown -y
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: <br>
‚ö†Ô∏è –ó–∞–º–µ–Ω–∏—Ç–µ ens1 –Ω–∞ –≤–∞—à –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—Å–∫–æ—Ä–µ–µ —ç—Ç–æ –±—É–¥–µ—Ç eth0 –∏–ª–∏ ens3)

```bash
sudo ifdown --force ens1 && sudo ifup ens1
resolvectl status
```

> \[!TIP]
> –ï—Å–ª–∏ –ø–æ—è–≤–∏–ª–∞—Å—å –æ—à–∏–±–∫–∞ `unknown interface`, —á–∏—Ç–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:
> [https://github.com/soulpastwk/share/blob/main/VPN/0\_Install/10\_Setting\_DNS\_errors.md](https://github.com/soulpastwk/share/blob/main/VPN/0_Install/10_Setting_DNS_errors.md)


## üõ† –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd-resolved

–í—Å—Ç–∞–≤–ª—è–µ–º –≤ `/etc/systemd/resolved.conf` —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ñ–∏–≥:

```ini
[Resolve]
# –û—Å–Ω–æ–≤–Ω–æ–π DNS —á–µ—Ä–µ–∑ DoT (–Ω–∏–∂–µ –ø–∏—à–µ–º –∏ –≤–∞—à –∞–π–ø–∏—à–Ω–∏–∫ –∏ —á–µ—Ä–µ–∑ –∑–Ω–∞–∫ # –ø–∏—à–µ–º –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è –≤–∞—à–µ–≥–æ –î–ù–° - —ç—Ç–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å DoT)
DNS=30.47.43.44#vash-domen-dns.ru

# –†–µ–∑–µ—Ä–≤–Ω—ã–π (Adguard DoT) (–Ω–∞ —Å–ª—É—á–∞–π –æ—Ç–∫–∞–∑–∞ –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞)
FallbackDNS=94.140.14.14#dns.adguard.com
FallbackDNS=94.140.15.15#dns.adguard.com

# –í–∫–ª—é—á–∏—Ç—å DoT
DNSOverTLS=yes

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DNSSEC, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
DNSSEC=allow-downgrade

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
Cache=yes

# –û—Ç–∫–ª—é—á–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã
MulticastDNS=no
LLMNR=no
```

---

## üöÄ –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥

–õ–∏–±–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–∞—à—É —Å–ª—É–∂–±—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å–µ—Ç–µ–≤—ã–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–ª–∏ –¥—Ä—É–≥—É—é.

```bash
netplan generate
netplan apply
systemctl restart systemd-resolved
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã DNS

–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–∑ —Ä–µ–∑–æ–ª–≤–µ—Ä–æ–≤ –ø—Ä–æ–ø–∞–ª–∏ `1.1.1.1` –∏ `8.8.8.8`, –∏ –æ—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞—à–∏ –∫–æ–Ω—Ñ–∏–≥–∏:

```bash
ip -c -br a
ip route
resolvectl status | grep 'DNS Servers' -A2
```

–í –≤—ã–≤–æ–¥–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –≤–∞—à–∏ IP-–∞–¥—Ä–µ—Å–∞ –∏ –Ω–∏—á–µ–≥–æ –±–æ–ª–µ–µ.

> \[!TIP]
> –ï—Å–ª–∏ –≤ –≤—ã–≤–æ–¥–µ –∫–æ–º–∞–Ω–¥—ã (resolvectl status | grep 'DNS Servers' -A2) <br>
> –≤–∏–¥–∏—Ç–µ DNS 1.1.1.1 –∏–ª–∏ 8.8.8.8
> –¢–æ –Ω–∞–¥–æ –∑–∞–∫–æ–º–∏—Ç–∏—Ç—å —Ñ–∞–π–ª **eth0** –ø—É—Ç—ë–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –µ–≥–æ –≤ **eth0.bak** –ø–æ –ø—É—Ç–∏ 

```bash
cd /etc/network/interfaces.d
```
![dns-11](https://github.com/soulpastwk/share/blob/main/media/vpn00/dns-011.png)

![dns-10](https://github.com/soulpastwk/share/blob/main/media/vpn00/dns-010.png)

#### üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã DNS:

```bash
apt update
apt install dnsutils -y       # dig
apt install knot-dnsutils -y  # kdig ‚úÖ
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–æ–ª–≤–∏–Ω–≥–∞:

```bash
dig +short @94.140.14.14 google.com
kdig @94.140.14.14 google.com ‚úÖ
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–µ–∫–ª–∞–º—ã (AdGuard DNS):

```bash
dig +short @94.140.14.14 doubleclick.net
# NXDOMAIN -> —Ä–µ–∫–ª–∞–º–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
–∏–ª–∏ 0.0.0.0 -> —Ä–µ–∫–ª–∞–º–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
```

